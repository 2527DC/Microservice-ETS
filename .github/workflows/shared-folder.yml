name: "DEPLOYMENT WORKFLOW - SHARED COMPONENTS"

on:
  push:
    branches:
      - main
    paths:
      - "shared/**"

jobs:
  deploy:
    name: "Deploy Shared Components"
    runs-on: ubuntu-latest

    steps:
      - name: "Checkout Repository"
        uses: actions/checkout@v3

      # Step 1: Copy shared folder to EC2
      - name: "Copy shared folder to EC2"
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "shared/*"
          target: "/opt/shared/"

      # Step 2: SSH into EC2 and update Docker volume
      - name: "Update Docker Volume with Shared Components"
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "üîß Creating docker volume for shared components..."
            docker volume create shared_data || echo "‚úÖ Volume already exists"

            echo "üì¶ Copying shared components into docker volume..."
            docker run --rm \
              -v shared_data:/shared_data \
              -v /opt/shared/:/source_shared \
              alpine sh -c "cp -r /source_shared/* /shared_data/" \
              || echo "‚ö†Ô∏è Failed to copy shared components."

            echo "‚úÖ Shared components copied successfully!"
            echo "üìã Listing docker volumes:"
            docker volume ls
